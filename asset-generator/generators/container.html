<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Generator - SpaceGameDev</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(52, 152, 219, 0.4);
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid rgba(46, 204, 113, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #2ecc71, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #95a5a6;
            font-size: 1.1rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            align-items: start;
        }

        .sidebar {
            background: rgba(26, 31, 58, 0.8);
            border: 2px solid rgba(46, 204, 113, 0.2);
            border-radius: 12px;
            padding: 25px;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .content {
            background: rgba(26, 31, 58, 0.8);
            border: 2px solid rgba(46, 204, 113, 0.2);
            border-radius: 12px;
            padding: 25px;
        }

        /* Control Panel Styles */
        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #2ecc71;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid rgba(46, 204, 113, 0.3);
            padding-bottom: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #95a5a6;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            background: rgba(10, 14, 26, 0.8);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95rem;
        }

        .input-group input[readonly] {
            background: rgba(10, 14, 26, 0.5);
            color: #7f8c8d;
        }

        .input-group small {
            display: block;
            color: #7f8c8d;
            margin-top: 4px;
            font-size: 0.85rem;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        /* Canvas Container */
        .canvas-container {
            margin-bottom: 30px;
        }

        .canvas-wrapper {
            background: #000;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        canvas {
            border: 2px solid rgba(46, 204, 113, 0.3);
            border-radius: 4px;
        }

        /* Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(10, 14, 26, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(46, 204, 113, 0.2);
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #95a5a6;
            font-size: 0.9rem;
        }

        /* Parameter Categories */
        .param-category {
            margin-bottom: 20px;
            background: rgba(10, 14, 26, 0.4);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(46, 204, 113, 0.2);
        }

        .category-header {
            padding: 12px 15px;
            background: rgba(46, 204, 113, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .category-header:hover {
            background: rgba(46, 204, 113, 0.15);
        }

        .category-title {
            font-weight: bold;
            color: #2ecc71;
        }

        .param-count {
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .toggle-icon {
            color: #2ecc71;
            font-weight: bold;
        }

        .param-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .param-list.expanded {
            max-height: 2000px;
        }

        .param-item {
            padding: 15px;
            border-top: 1px solid rgba(46, 204, 113, 0.1);
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .param-name {
            font-weight: 500;
            color: #e0e0e0;
        }

        .param-type {
            color: #95a5a6;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .param-description {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .param-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .param-control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(46, 204, 113, 0.2);
            outline: none;
        }

        .param-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2ecc71;
            cursor: pointer;
        }

        .param-control input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2ecc71;
            cursor: pointer;
            border: none;
        }

        .param-value {
            text-align: center;
            font-weight: bold;
            color: #2ecc71;
            padding: 6px;
            background: rgba(10, 14, 26, 0.6);
            border-radius: 4px;
        }

        /* Animation Grid */
        .sprite-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(10, 14, 26, 0.4);
            border-radius: 8px;
        }

        .sprite-grid h4 {
            grid-column: 1 / -1;
            color: #2ecc71;
            margin-bottom: 10px;
        }

        
        .sprite-grid #grid-info {
            color: #95a5a6;
            font-size: 0.9rem;
            font-weight: normal;
        }

        .frame-canvas {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 4px;
            background: #000;
            cursor: pointer;
            transition: all 0.2s;
        }

        .frame-canvas:hover {
            border-color: rgba(52, 152, 219, 0.6);
            transform: scale(1.05);
        }

        .frame-canvas.active {
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);
            transform: scale(1.05);
        }

        .frame-canvas.empty {
            background: rgba(52, 152, 219, 0.05);
            border-style: dashed;
        }

        /* Sidebar Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(10, 14, 26, 0.6);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(46, 204, 113, 0.4);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(46, 204, 113, 0.6);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../hub.html" class="back-btn">‚Üê Back to Hub</a>

        <header>
            <h1>üì¶ Container Generator</h1>
            <p class="subtitle">18 Parameters - Cargo Container Generation (Mineral, Gas, Liquid, Ammo)</p>
        </header>

        <div class="main-layout">
            <!-- Left Sidebar - Controls -->
            <div class="sidebar">
                <!-- Seed & Preset Controls -->
                <div class="control-section">
                    <h3>üîë Generation Controls</h3>

                    <div class="input-group">
                        <label>Preset (Type)</label>
                        <select id="preset-select">
                            <option value="">Custom Configuration</option>
                            <option value="mineral_standard">Mineral - Standard</option>
                            <option value="gas_pressurized">Gas - Pressurized</option>
                            <option value="liquid_tank">Liquid - Tank</option>
                            <option value="ammo_crate">Ammo - Crate</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Item ID (Database)</label>
                        <input type="text" id="item-id" value="CNT_MINERAL_IRON_A5_00001" placeholder="e.g., CNT_MINERAL_IRON_A5_00001">
                    </div>

                    <div class="input-group">
                        <label>Variant</label>
                        <input type="text" id="variant" value="mineral" placeholder="e.g., mineral, gas, liquid">
                    </div>

                    <div class="input-group">
                        <label>Seed (Auto-generated)</label>
                        <input type="text" id="seed-display" readonly>
                    </div>

                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="use-seed-randomization" checked>
                            <span>Use Seed Randomization</span>
                        </label>
                        <small style="color: #95a5a6; font-size: 0.85rem;">
                            Unchecked: Manual parameter control<br>
                            Checked: Seed-based variance applied
                        </small>
                    </div>

                    <button class="btn" onclick="regenerate()">üì¶ Generate Container</button>
                    </div>

                <!-- Sprite Sheet Controls -->
                <div class="control-section">
                    <h3>üé¨ Sprite Sheet</h3>

                    <div class="input-group">
                        <label>Grid Layout</label>
                        <select id="grid-layout">
                            <option value="4x1">4x1 (4 frames, 1 row)</option>
                            <option value="4x2" selected>4x2 (8 frames)</option>
                            <option value="8x2">8x2 (16 frames)</option>
                            <option value="16x2">16x2 (32 frames)</option>
                        </select>
                    </div>

                    <button class="btn btn-success" onclick="generateAllFrames()">üé¨ Generate All Frames</button>
                    <button class="btn btn-secondary" onclick="clearAllFrames()">üóëÔ∏è Clear All Frames</button>

                    <div class="input-group">
                        <label>Active Frame: <span id="active-frame-display">None</span></label>
                        <small>Click a frame below to edit its parameters</small>
                    </div>

                    <div class="input-group">
                        <label>Pivot Point (Anchor)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="pivot-x" value="0.5" step="0.1" min="0" max="1" style="flex: 1;" placeholder="X (0-1)">
                            <input type="number" id="pivot-y" value="0.5" step="0.1" min="0" max="1" style="flex: 1;" placeholder="Y (0-1)">
                        </div>
                        <small>Center of rotation/attachment (0.5, 0.5 = center)</small>
                    </div>
                </div>

                <!-- Export/Import -->
                <div class="control-section">
                    <h3>üíæ Export</h3>
                    <button class="btn btn-success" onclick="exportSpriteSheet()">üñºÔ∏è Export PNG Sprite Sheet</button>
                    <button class="btn btn-secondary" onclick="exportConfig()">üì• Export JSON Config</button>
                    <button class="btn btn-secondary" onclick="importConfig()">üì§ Import JSON Config</button>
                    <input type="file" id="file-input" accept=".json" style="display: none;">

                    <div class="input-group">
                        <label>Export Settings</label>
                        <select id="export-scale">
                            <option value="1">1x (128px per frame)</option>
                            <option value="2" selected>2x (256px per frame)</option>
                            <option value="4">4x (512px per frame)</option>
                            <option value="8">8x (1024px per frame)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Right Content - Canvas & Parameters -->
            <div class="content">
                <!-- Canvas Display -->
                <div class="canvas-container">
                    <h3 style="color: #2ecc71; margin-bottom: 15px;">Preview</h3>
                    <div class="canvas-wrapper">
                        <canvas id="main-canvas" width="512" height="512"></canvas>
                    </div>

                    <!-- Animation Grid (8 Frames) -->
                    <div class="sprite-grid" id="sprite-grid">
                        <h4>Sprite Sheet Frames <span id="grid-info">(4x2 = 8 frames)</span></h4>
                        <!-- Frames generated dynamically by JavaScript -->
                        
                        
                        
                        
                        
                        
                        
                        
                    </div>

                    <!-- Stats -->
                    <div class="stats-panel">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-vertices">0</div>
                            <div class="stat-label">Vertices</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-panels">0</div>
                            <div class="stat-label">Panels</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-glow">0%</div>
                            <div class="stat-label">Glow</div>
                        </div>
                    </div>
                </div>

                <!-- Parameter Categories -->
                <div id="parameters-container">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="../shared/seed-system.js"></script>
    <script src="../shared/parameter-manager.js"></script>

    <script>
        // Global instances
        let seedSystem;
        let paramManager;
        let currentSeed;
        // Frame management
        let frameParameters = {};  // Stores parameters for each frame
        let activeFrame = null;     // Currently selected frame index
        let currentGridLayout = '4x2';  // Current grid layout

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load parameter definitions
                const response = await fetch('../parameters/container_params.json');
                const paramDefs = await response.json();

                // Initialize systems
                seedSystem = new SeedSystem();
                paramManager = new ParameterManager(paramDefs);

                // Generate UI
                generateParameterUI();

                // Set up event listeners
                setupEventListeners();

                // Build sprite grid
                buildSpriteGrid();

                // Initial generation
                regenerate();

            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to load parameter definitions. Check console for details.');
            }
        });

        function setupEventListeners() {
            // Preset selection
            document.getElementById('preset-select').addEventListener('change', (e) => {
                if (e.target.value) {
                    paramManager.loadPreset(e.target.value);
                    updateUIFromParameters();
                    regenerate();
                }
            });

            // Item ID and variant changes
            document.getElementById('item-id').addEventListener('change', regenerate);
            document.getElementById('variant').addEventListener('change', regenerate);

            // Seed randomization toggle
            document.getElementById('use-seed-randomization').addEventListener('change', regenerate);
        }

        function generateParameterUI() {
            const container = document.getElementById('parameters-container');
            container.innerHTML = '';

            const categories = paramManager.definitions.categories;

            for (const [categoryId, category] of Object.entries(categories)) {
                const categoryDiv = createCategoryUI(categoryId, category);
                container.appendChild(categoryDiv);
            }
        }

        function createCategoryUI(categoryId, category) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'param-category';

            const paramCount = Object.keys(category.parameters).length;

            // Header
            const header = document.createElement('div');
            header.className = 'category-header';
            header.onclick = () => toggleCategory(categoryId);
            header.innerHTML = `
                <span class="category-title">${category.name || categoryId}</span>
                <span class="param-count">${paramCount} Parameters</span>
                <span class="toggle-icon" id="toggle-${categoryId}">‚ñ≤</span>
            `;
            categoryDiv.appendChild(header);

            // Parameter list (expanded by default)
            const paramList = document.createElement('div');
            paramList.className = 'param-list expanded';
            paramList.id = `list-${categoryId}`;

            for (const [paramKey, param] of Object.entries(category.parameters)) {
                const paramItem = createParameterControl(paramKey, param);
                paramList.appendChild(paramItem);
            }

            categoryDiv.appendChild(paramList);

            return categoryDiv;
        }

        function createParameterControl(key, param) {
            const item = document.createElement('div');
            item.className = 'param-item';

            const header = document.createElement('div');
            header.className = 'param-header';
            header.innerHTML = `
                <span class="param-name">${key}</span>
                <span class="param-type">${param.type}</span>
            `;
            item.appendChild(header);

            const description = document.createElement('div');
            description.className = 'param-description';
            description.textContent = param.description || '';
            item.appendChild(description);

            // Control based on type
            if (param.type === 'enum') {
                const select = document.createElement('select');
                select.id = `param-${key}`;
                select.style.width = '100%';
                select.style.padding = '8px';
                select.style.background = 'rgba(10, 14, 26, 0.8)';
                select.style.border = '1px solid rgba(46, 204, 113, 0.3)';
                select.style.borderRadius = '6px';
                select.style.color = '#e0e0e0';

                param.values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });

                select.value = param.default;
                select.addEventListener('change', (e) => {
                    paramManager.setValue(key, e.target.value);
                    regenerate();
                });

                item.appendChild(select);

            } else if (param.type === 'bool') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `param-${key}`;
                checkbox.checked = param.default;
                checkbox.addEventListener('change', (e) => {
                    paramManager.setValue(key, e.target.checked);
                    regenerate();
                });

                const label = document.createElement('label');
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(' Enable'));
                label.style.color = '#95a5a6';
                item.appendChild(label);

            } else {
                // Numeric (float/int) with slider
                const control = document.createElement('div');
                control.className = 'param-control';

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.id = `param-${key}`;
                slider.min = param.min;
                slider.max = param.max;
                slider.step = param.type === 'int' ? 1 : 0.01;
                slider.value = param.default;

                const valueDisplay = document.createElement('div');
                valueDisplay.className = 'param-value';
                valueDisplay.id = `value-${key}`;
                valueDisplay.textContent = param.default;

                slider.addEventListener('input', (e) => {
                    const value = param.type === 'int'
                        ? parseInt(e.target.value)
                        : parseFloat(e.target.value);

                    valueDisplay.textContent = param.type === 'int'
                        ? value
                        : value.toFixed(2);

                    paramManager.setValue(key, value);
                    regenerate();
                });

                control.appendChild(slider);
                control.appendChild(valueDisplay);
                item.appendChild(control);
            }

            return item;
        }

        function toggleCategory(categoryId) {
            const list = document.getElementById(`list-${categoryId}`);
            const icon = document.getElementById(`toggle-${categoryId}`);

            if (list.classList.contains('expanded')) {
                list.classList.remove('expanded');
                icon.textContent = '‚ñº';
            } else {
                list.classList.add('expanded');
                icon.textContent = '‚ñ≤';
            }
        }

        function updateUIFromParameters() {
            for (const [categoryId, category] of Object.entries(paramManager.definitions.categories)) {
                for (const paramKey of Object.keys(category.parameters)) {
                    const value = paramManager.getValue(paramKey);
                    const element = document.getElementById(`param-${paramKey}`);
                    const valueDisplay = document.getElementById(`value-${paramKey}`);

                    if (element) {
                        element.value = value;
                        if (valueDisplay) {
                            const param = paramManager.getDefinition(paramKey);
                            valueDisplay.textContent = param.type === 'int'
                                ? value
                                : value.toFixed(2);
                        }
                    }
                }
            }
        }

        function regenerate() {
            const itemId = document.getElementById('item-id').value || 'CNT_MINERAL_IRON_A5_00001';
            const variant = document.getElementById('variant').value || 'mineral';
            const useSeedRandomization = document.getElementById('use-seed-randomization').checked;

            // Generate seed (frame 0 for main canvas)
            currentSeed = seedSystem.generateSeed('container', itemId, variant, 0);
            document.getElementById('seed-display').value = currentSeed;

            let params;

            if (useSeedRandomization) {
                // Create RNG and get randomized parameters
                const rng = seedSystem.createRNG(currentSeed);
                params = paramManager.getAllRandomized(rng);
            } else {
                // Use current manual parameter values
                params = paramManager.currentValues;
            }

            // Render container
            renderContainer('main-canvas', params);

            // Update stats
            updateStats(params);
        }

        function generateAnimation() {
            const itemId = document.getElementById('item-id').value || 'CNT_MINERAL_IRON_A5_00001';
            const variant = document.getElementById('variant').value || 'mineral';

            // Generate 8 frames
            for (let frame = 0; frame < 8; frame++) {
                const seed = seedSystem.generateSeed('container', itemId, variant, frame);
                const rng = seedSystem.createRNG(seed);
                const params = paramManager.getAllRandomized(rng);

                renderContainer(`frame-${frame}`, params);
            }

            alert('8-frame animation generated! Each frame uses a different seed.');
        }

        function renderContainer(canvasId, params) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            const centerX = width / 2;
            const centerY = height / 2;
            const baseSize = Math.min(width, height) * 0.4;

            // Convert HSL to RGB
            const hue = params.hue || 200;
            const saturation = params.saturation || 0.6;
            const lightness = 0.5;

            const baseColor = `hsl(${hue}, ${saturation * 100}%, ${lightness * 100}%)`;
            const glowColor = getGlowColor(params.content_glow_color);

            // Draw based on shape_type
            ctx.save();
            ctx.translate(centerX, centerY);

            switch (params.shape_type) {
                case 'cubic':
                    drawCubicContainer(ctx, baseSize, params, baseColor, glowColor);
                    break;
                case 'cylindrical':
                    drawCylindricalContainer(ctx, baseSize, params, baseColor, glowColor);
                    break;
                case 'spherical':
                    drawSphericalContainer(ctx, baseSize, params, baseColor, glowColor);
                    break;
                case 'crate':
                    drawCrateContainer(ctx, baseSize, params, baseColor, glowColor);
                    break;
                default:
                    drawCubicContainer(ctx, baseSize, params, baseColor, glowColor);
            }

            // Add weathering
            if (params.weathering > 0) {
                drawWeathering(ctx, baseSize, params.weathering);
            }

            ctx.restore();
        }

        function drawCubicContainer(ctx, size, params, color, glowColor) {
            const w = size;
            const h = size * 0.8;

            // Main body
            ctx.fillStyle = color;
            ctx.fillRect(-w/2, -h/2, w, h);

            // Metallic shine
            const gradient = ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
            gradient.addColorStop(0, `rgba(255, 255, 255, ${params.metallic * 0.3})`);
            gradient.addColorStop(0.5, `rgba(255, 255, 255, ${params.metallic * 0.1})`);
            gradient.addColorStop(1, `rgba(0, 0, 0, ${params.metallic * 0.2})`);
            ctx.fillStyle = gradient;
            ctx.fillRect(-w/2, -h/2, w, h);

            // Panels
            ctx.strokeStyle = `rgba(0, 0, 0, 0.4)`;
            ctx.lineWidth = 2;
            for (let i = 0; i < params.panel_count; i++) {
                const y = -h/2 + (h / (params.panel_count + 1)) * (i + 1);
                ctx.beginPath();
                ctx.moveTo(-w/2 + 10, y);
                ctx.lineTo(w/2 - 10, y);
                ctx.stroke();
            }

            // Glow
            if (glowColor && params.glow_intensity > 0) {
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 20 * params.glow_intensity;
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 3;
                ctx.strokeRect(-w/2, -h/2, w, h);
            }

            // Hazard stripes
            if (params.hazard_stripes) {
                drawHazardStripes(ctx, w, h);
            }
        }

        function drawCylindricalContainer(ctx, size, params, color, glowColor) {
            const radius = size * 0.4;
            const height = size * 0.8;

            // Main cylinder body
            ctx.fillStyle = color;
            ctx.fillRect(-radius, -height/2, radius * 2, height);

            // Top cap (ellipse)
            ctx.beginPath();
            ctx.ellipse(0, -height/2, radius, radius * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();

            // Bottom cap
            ctx.beginPath();
            ctx.ellipse(0, height/2, radius, radius * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();

            // Metallic gradient
            const gradient = ctx.createLinearGradient(-radius, 0, radius, 0);
            gradient.addColorStop(0, `rgba(0, 0, 0, ${params.metallic * 0.3})`);
            gradient.addColorStop(0.5, `rgba(255, 255, 255, ${params.metallic * 0.4})`);
            gradient.addColorStop(1, `rgba(0, 0, 0, ${params.metallic * 0.3})`);
            ctx.fillStyle = gradient;
            ctx.fillRect(-radius, -height/2, radius * 2, height);

            // Glow
            if (glowColor && params.glow_intensity > 0) {
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 25 * params.glow_intensity;
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 3;
                ctx.strokeRect(-radius, -height/2, radius * 2, height);
            }

            // Hazard stripes
            if (params.hazard_stripes) {
                drawHazardStripes(ctx, radius * 2, height);
            }
        }

        function drawSphericalContainer(ctx, size, params, color, glowColor) {
            const radius = size * 0.5;

            // Main sphere
            const gradient = ctx.createRadialGradient(
                -radius * 0.3, -radius * 0.3, 0,
                0, 0, radius
            );
            gradient.addColorStop(0, `rgba(255, 255, 255, ${params.metallic * 0.3})`);
            gradient.addColorStop(0.5, color);
            gradient.addColorStop(1, `rgba(0, 0, 0, ${params.metallic * 0.4})`);

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2);
            ctx.fill();

            // Glow
            if (glowColor && params.glow_intensity > 0) {
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 30 * params.glow_intensity;
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function drawCrateContainer(ctx, size, params, color, glowColor) {
            const w = size * 1.1;
            const h = size * 0.7;

            // Main crate body
            ctx.fillStyle = color;
            ctx.fillRect(-w/2, -h/2, w, h);

            // Wood/metal planks
            ctx.strokeStyle = `rgba(0, 0, 0, 0.5)`;
            ctx.lineWidth = 4;
            for (let i = 0; i <= params.panel_count; i++) {
                const x = -w/2 + (w / params.panel_count) * i;
                ctx.beginPath();
                ctx.moveTo(x, -h/2);
                ctx.lineTo(x, h/2);
                ctx.stroke();
            }

            // Corner reinforcements
            const cornerSize = 20;
            ctx.fillStyle = `rgba(255, 255, 255, ${params.metallic})`;
            ctx.fillRect(-w/2, -h/2, cornerSize, cornerSize);
            ctx.fillRect(w/2 - cornerSize, -h/2, cornerSize, cornerSize);
            ctx.fillRect(-w/2, h/2 - cornerSize, cornerSize, cornerSize);
            ctx.fillRect(w/2 - cornerSize, h/2 - cornerSize, cornerSize, cornerSize);

            // Hazard stripes
            if (params.hazard_stripes) {
                drawHazardStripes(ctx, w, h);
            }

            // Glow (subtle on crates)
            if (glowColor && params.glow_intensity > 0) {
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 15 * params.glow_intensity;
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 2;
                ctx.strokeRect(-w/2, -h/2, w, h);
            }
        }

        function drawHazardStripes(ctx, width, height) {
            const stripeWidth = 20;
            const stripeAngle = Math.PI / 4;

            ctx.save();
            ctx.globalAlpha = 0.7;
            ctx.strokeStyle = '#ffcc00';
            ctx.lineWidth = stripeWidth;

            for (let i = -width; i < width * 2; i += stripeWidth * 2) {
                ctx.beginPath();
                ctx.moveTo(i - width/2, -height/2);
                ctx.lineTo(i - width/2 + height, height/2);
                ctx.stroke();
            }

            ctx.restore();
        }

        function drawWeathering(ctx, size, intensity) {
            ctx.globalAlpha = intensity * 0.3;
            ctx.fillStyle = '#000';

            for (let i = 0; i < intensity * 50; i++) {
                const x = (Math.random() - 0.5) * size;
                const y = (Math.random() - 0.5) * size;
                const r = Math.random() * 3;

                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.globalAlpha = 1.0;
        }

        function getGlowColor(colorName) {
            const colors = {
                'none': null,
                'blue': '#3498db',
                'green': '#2ecc71',
                'red': '#e74c3c',
                'yellow': '#f1c40f',
                'orange': '#e67e22'
            };
            return colors[colorName] || null;
        }

        function updateStats(params) {
            // Calculate approximate vertices based on shape
            let vertices = 0;
            switch (params.shape_type) {
                case 'cubic': vertices = 8; break;
                case 'cylindrical': vertices = 24; break;
                case 'spherical': vertices = 32; break;
                case 'crate': vertices = 12; break;
            }

            document.getElementById('stat-vertices').textContent = vertices;
            document.getElementById('stat-panels').textContent = params.panel_count || 0;
            document.getElementById('stat-glow').textContent = Math.round((params.glow_intensity || 0) * 100) + '%';
        }

                ctx.beginPath();
                ctx.moveTo(vx, vy);
                for (let j = 0; j < 5; j++) {
                    const branchAngle = angle + (Math.random() - 0.5) * Math.PI / 2;
                    const branchLength = 10 + Math.random() * 20;
                    const bx = vx + Math.cos(branchAngle) * branchLength;
                    const by = vy + Math.sin(branchAngle) * branchLength;
                    ctx.lineTo(bx, by);
                }
                ctx.stroke();

                ctx.shadowBlur = 0;
            }
        }

        function updateStats(params) {
            // Estimate vertices based on shape type
            let vertexCount = 24;
            if (params.shape_type === 'crystalline') {
                vertexCount = params.facet_count || 8;
            } else if (params.shape_type === 'sphere') {
                vertexCount = 32;
            }

            document.getElementById('stat-vertices').textContent = vertexCount;
            document.getElementById('stat-craters').textContent = Math.floor((params.crater_density || 0) * 0.5);
            document.getElementById('stat-veins').textContent = params.ore_vein_count || 0;
        }

        // ========================================================================
        // SPRITE SHEET FRAME MANAGEMENT
        // ========================================================================

        function buildSpriteGrid() {
            const [cols, rows] = currentGridLayout.split('x').map(Number);
            const totalFrames = cols * rows;

            const grid = document.getElementById('sprite-grid');
            const gridInfo = document.getElementById('grid-info');
            gridInfo.textContent = `(${currentGridLayout} = ${totalFrames} frames)`;

            // Clear existing frames
            const existingFrames = grid.querySelectorAll('.frame-canvas');
            existingFrames.forEach(f => f.remove());

            // Update grid columns
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            // Create frames
            for (let i = 0; i < totalFrames; i++) {
                const canvas = document.createElement('canvas');
                canvas.id = `frame-${i}`;
                canvas.className = 'frame-canvas empty';
                canvas.width = 128;
                canvas.height = 128;
                canvas.dataset.frameIndex = i;

                canvas.addEventListener('click', () => onFrameClick(i));

                grid.appendChild(canvas);
            }
        }

        function onFrameClick(frameIndex) {
            // Deselect previous frame
            if (activeFrame !== null) {
                const prevCanvas = document.getElementById(`frame-${activeFrame}`);
                if (prevCanvas) prevCanvas.classList.remove('active');
            }

            // Select new frame
            activeFrame = frameIndex;
            const canvas = document.getElementById(`frame-${frameIndex}`);
            canvas.classList.add('active');

            document.getElementById('active-frame-display').textContent = `Frame ${frameIndex}`;

            // Load frame's parameters if they exist
            if (frameParameters[frameIndex]) {
                loadFrameParameters(frameIndex);
            }
        }

        function saveCurrentFrameParameters() {
            if (activeFrame === null) return;

            // Save current UI parameters to the active frame
            frameParameters[activeFrame] = {
                ...paramManager.currentValues
            };

            console.log(`Saved parameters for frame ${activeFrame}`);
        }

        function loadFrameParameters(frameIndex) {
            if (!frameParameters[frameIndex]) return;

            // Load frame's parameters into UI
            const params = frameParameters[frameIndex];

            for (const [key, value] of Object.entries(params)) {
                paramManager.setValue(key, value, false);
            }

            updateUIFromParameters();
            regenerate();
        }

        function generateAllFrames() {
            const useSeedRandomization = document.getElementById('use-seed-randomization').checked;
            const itemId = document.getElementById('item-id').value || 'ORE_T1_001';
            const variant = document.getElementById('variant').value || 'iron';

            const [cols, rows] = currentGridLayout.split('x').map(Number);
            const totalFrames = cols * rows;

            for (let i = 0; i < totalFrames; i++) {
                // Generate seed for this frame
                const seed = seedSystem.generateSeed('asteroid', itemId, variant, i);
                const rng = seedSystem.createRNG(seed);

                let params;
                if (useSeedRandomization) {
                    params = paramManager.getAllRandomized(rng);
                } else {
                    params = { ...paramManager.currentValues };
                }

                // Store frame parameters
                frameParameters[i] = params;

                // Render frame
                const canvas = document.getElementById(`frame-${i}`);
                if (canvas) {
                    canvas.classList.remove('empty');
                    renderContainerToCanvas(canvas, params);
                }
            }

            alert(`Generated ${totalFrames} frames!`);
        }

        function clearAllFrames() {
            const [cols, rows] = currentGridLayout.split('x').map(Number);
            const totalFrames = cols * rows;

            for (let i = 0; i < totalFrames; i++) {
                const canvas = document.getElementById(`frame-${i}`);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    canvas.classList.add('empty');
                    canvas.classList.remove('active');
                }
            }

            frameParameters = {};
            activeFrame = null;
            document.getElementById('active-frame-display').textContent = 'None';
        }

        function renderContainerToCanvas(canvas, params) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            const centerX = width / 2;
            const centerY = height / 2;
            const baseRadius = Math.min(width, height) * 0.35;




        function exportConfig() {
            const config = {
                itemId: document.getElementById('item-id').value,
                variant: document.getElementById('variant').value,
                seed: currentSeed,
                parameters: paramManager.exportJSON()
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `container_${config.itemId}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importConfig() {
            const input = document.getElementById('file-input');
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const config = JSON.parse(event.target.result);

                        if (config.itemId) document.getElementById('item-id').value = config.itemId;
                        if (config.variant) document.getElementById('variant').value = config.variant;

                        if (config.parameters) {
                            paramManager.importJSON(config.parameters);
                            updateUIFromParameters();
                        }

                        regenerate();
                    } catch (error) {
                        alert('Failed to import configuration: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        // ========================================================================
        // PNG SPRITE SHEET EXPORT
        // ========================================================================

        function exportSpriteSheet() {
            const [cols, rows] = currentGridLayout.split('x').map(Number);
            const totalFrames = cols * rows;
            const scale = parseInt(document.getElementById('export-scale').value);
            const frameSize = 128 * scale;
            const pivotX = parseFloat(document.getElementById('pivot-x').value);
            const pivotY = parseFloat(document.getElementById('pivot-y').value);

            // Create export canvas
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = cols * frameSize;
            exportCanvas.height = rows * frameSize;
            const ctx = exportCanvas.getContext('2d');

            // Fill background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

            // Check if any frames exist
            let hasFrames = false;
            for (let i = 0; i < totalFrames; i++) {
                if (frameParameters[i]) {
                    hasFrames = true;
                    break;
                }
            }

            if (!hasFrames) {
                alert('No frames generated! Click "Generate All Frames" first.');
                return;
            }

            // Render each frame
            for (let i = 0; i < totalFrames; i++) {
                const row = Math.floor(i / cols);
                const col = i % cols;
                const x = col * frameSize;
                const y = row * frameSize;

                if (frameParameters[i]) {
                    // Create temporary canvas at export scale
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = frameSize;
                    tempCanvas.height = frameSize;
                    const tempCtx = tempCanvas.getContext('2d');

                    // Scale up rendering
                    tempCtx.scale(scale, scale);

                    // Render asteroid
                    renderContainerToTempCanvas(tempCtx, frameParameters[i], 128);

                    // Copy to export canvas
                    ctx.drawImage(tempCanvas, x, y);

                    // Draw pivot point marker (magenta crosshair)
                    const pivotPxX = x + frameSize * pivotX;
                    const pivotPxY = y + frameSize * pivotY;

                    ctx.strokeStyle = '#ff00ff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(pivotPxX - 5, pivotPxY);
                    ctx.lineTo(pivotPxX + 5, pivotPxY);
                    ctx.moveTo(pivotPxX, pivotPxY - 5);
                    ctx.lineTo(pivotPxX, pivotPxY + 5);
                    ctx.stroke();
                }
            }

            // Download
            exportCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const itemId = document.getElementById('item-id').value || 'asteroid';
                a.download = `${itemId}_spritesheet_${currentGridLayout}_${frameSize}px.png`;
                a.click();
                URL.revokeObjectURL(url);

                alert(`Exported ${cols}x${rows} sprite sheet!
Size: ${exportCanvas.width}x${exportCanvas.height}px
Pivot: (${pivotX}, ${pivotY})
Scale: ${scale}x`);
            });
        }

        function renderContainerToTempCanvas(ctx, params, size) {
            const centerX = size / 2;
            const centerY = size / 2;
            const baseRadius = size * 0.35;

            // Apply elongation
            const radiusX = baseRadius * params.elongation_x;
            const radiusY = baseRadius * params.elongation_y;

            // Draw asteroid
            const gradient = ctx.createRadialGradient(
                centerX - radiusX * 0.3, centerY - radiusY * 0.3, 0,
                centerX, centerY, Math.max(radiusX, radiusY)
            );

            const hue = params.base_color_hue || 30;
            gradient.addColorStop(0, `hsl(${hue}, 70%, 50%)`);
            gradient.addColorStop(0.7, `hsl(${hue}, 50%, 30%)`);
            gradient.addColorStop(1, `hsl(${hue}, 30%, 15%)`);

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
            ctx.fill();

            // Add ore glow
            if (params.purity_glow > 0) {
                ctx.shadowColor = `hsl(${hue + 30}, 100%, 60%)`;
                ctx.shadowBlur = 15 * params.purity_glow;
                ctx.strokeStyle = `hsla(${hue + 30}, 100%, 60%, ${params.purity_glow * 0.5})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }


    </script>
</body>
</html>
